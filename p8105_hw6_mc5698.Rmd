---
title: "p8105_hw6_mc5698"
output: github_document
date: "2024-11-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(tidyverse)
library(rnoaa)
library(broom)
library(purrr)
library(modelr)
library(boot) 
library(rsample)
library(p8105.datasets)
```


#Problem 1
```{r message=FALSE}
#Read dataset
set.seed(1)

weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```

```{r}
#Define function
bootstrap_results <- map_df(1:5000, function(i) {
  sample_df <- weather_df %>% sample_frac(size = 1, replace = TRUE)
  lm_model <- lm(tmax ~ tmin, data = sample_df)
  
  glance_metrics <- glance(lm_model)
  tidy_metrics <- tidy(lm_model)
  
  r_squared <- glance_metrics$r.squared
  log_beta <- log(tidy_metrics$estimate[1] * tidy_metrics$estimate[2])
  
  tibble(
    r_squared = r_squared,
    log_beta = log_beta)})

```

```{r}
# Confidence Intervals
ci_r_squared <- quantile(bootstrap_results$r_squared, probs = c(0.025, 0.975))
ci_log_beta <- quantile(bootstrap_results$log_beta, probs = c(0.025, 0.975))

ci_r_squared
ci_log_beta
```

```{r}
# Plot Results
bootstrap_results %>%
  pivot_longer(everything(), names_to = "metric", values_to = "value") %>%
  ggplot(aes(x = value)) +
  geom_histogram(bins = 30, fill = "blue", alpha = 0.7) +
  facet_wrap(~ metric, scales = "free", ncol = 1) +
  theme_minimal() +
  labs(title = "Bootstrap Distributions", x = "Value", y = "Count")
```

#Problem 2
```{r message=FALSE}
# Load the data
homicide_data <- read_csv("data/homicide-data.csv")
```

```{r warning=FALSE}
# Data Cleaning
omit_cities <- c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL")

filtered_data <- homicide_data %>%
  mutate(
    city_state = paste(city, state, sep = ", "),
    solved = if_else(str_detect(disposition, "Closed"), 1, 0),
    victim_age = as.numeric(victim_age)
  ) %>%
  filter(
    !city_state %in% omit_cities,
    victim_race %in% c("White", "Black")
  ) %>%
  drop_na(victim_age, victim_sex, victim_race, solved)


```

```{r}
# Model for Baltimore
baltimore_data <- filtered_data %>%
  filter(city_state == "Baltimore, MD")

baltimore_model <- glm(solved ~ victim_age + victim_sex + victim_race, 
                       data = baltimore_data, family = binomial)

baltimore_results <- broom::tidy(baltimore_model, conf.int = TRUE) %>%
  filter(term == "victim_sexMale") %>%
  mutate(
    odds_ratio = exp(estimate),
    ci_lower = exp(conf.low),
    ci_upper = exp(conf.high)
  )

baltimore_results %>% 
  select(odds_ratio, ci_lower, ci_upper)

```
```{r warning=FALSE}
#For All Cities
city_results <- filtered_data %>%
  group_by(city_state) %>%
  nest() %>%
  mutate(
    model = map(data, ~ glm(solved ~ victim_age + victim_sex + victim_race, 
                            data = ., family = binomial)),
    tidy_model = purrr::map(model, ~ tryCatch(tidy(.x, conf.int = TRUE), 
                                       error = function(e) NULL))) %>%
  unnest(tidy_model) %>%
  filter(term == "victim_sexMale") %>%
  mutate(
    odds_ratio = exp(estimate),
    ci_lower = exp(conf.low),
    ci_upper = exp(conf.high)
  ) %>%
  select(city_state, odds_ratio, ci_lower, ci_upper)
city_results 
```

```{r}
# plot
city_results %>%
  arrange(odds_ratio) %>%
  ggplot(aes(x = reorder(city_state, odds_ratio), y = odds_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2) +
  coord_flip() +
  labs(
    title = "Estimated Odds Ratios and Confidence Intervals for Solving Homicides by City",
    x = "City",
    y = "Odds Ratio (Male vs Female)"
  ) +
  theme_minimal()

```
The graph shows the estimated odds ratios and 95% confidence intervals for solving homicides comparing male to female victims across various U.S. cities. In most cities, such as Baltimore and Atlanta, the ORs are below 1, suggesting that homicides involving male victims are less likely to be solved compared to female victims. Moreover, some cities like Fresno and Birmingham, have confidence intervals that cross 1, implying that the difference in solving rates between male and female victims may not be statistically significant in those locations.

#Problem 3
```{r}
#Read data
birthweight_data <- read_csv("data/birthweight.csv")

# Data Cleaning
omit_cols <- c("bhead", "blength", "delwt", "fincome", "gaweeks", "mheight", 
               "momage", "parity", "ppbmi", "smoken", "wtgain", "bwt")

birthweight_clean <- birthweight_data %>%
  select(all_of(omit_cols)) %>%
  drop_na()

```
```{r}
# Split the Data
set.seed(123)
birthweight_split <- initial_split(birthweight_clean, prop = 0.7)
birthweight_train <- training(birthweight_split)
birthweight_test <- testing(birthweight_split)

# Fit a linear model 
linear_model <- lm(bwt ~ ., data = birthweight_train)

# Use broom to tidy the model output
linear_model_summary <- tidy(linear_model)
```

```{r}
# Predict dataset
birthweight_test <- birthweight_test %>%
  mutate(predicted_bwt = predict(linear_model, newdata = birthweight_test))

# R-squared and RMSE
rmse <- birthweight_test %>%
  summarise(rmse = sqrt(mean((bwt - predicted_bwt)^2))) %>%
  pull(rmse)

rsq <- birthweight_test %>%
  summarise(
    ss_total = sum((bwt - mean(bwt))^2),
    ss_residual = sum((bwt - predicted_bwt)^2),
    rsq = 1 - (ss_residual / ss_total)
  ) %>%
  pull(rsq)

model_metrics <- tibble(
  Metric = c("RMSE", "R-squared"),
  Value = c(rmse, rsq)
)
model_metrics


```

```{r}
#Cross-Validation
set.seed(123)
cv_folds <- vfold_cv(birthweight_train, v = 10)

cv_results <- cv_folds %>%
  mutate(
    model = map(splits, ~ lm(bwt ~ ., data = analysis(.x))),
    metrics = map2(
      splits, model, 
      ~ {
        test_data <- assessment(.x)
        predictions <- predict(.y, newdata = test_data)
        tibble(
          rmse = sqrt(mean((test_data$bwt - predictions)^2)),
          rsq = 1 - sum((test_data$bwt - predictions)^2) / sum((test_data$bwt - mean(test_data$bwt))^2) )
      }
    )
  ) %>%
  unnest(metrics)

cv_summary <- cv_results %>%
  summarise(
    avg_rmse = mean(rmse),
    avg_rsq = mean(rsq)
  )
cv_summary

```

```{r}
# Bootstrapping
set.seed(123)
bootstrap_results <- boot(
  data = birthweight_train,
  statistic = function(data, indices) {
    sample_data <- data[indices, ]
    model <- lm(bwt ~ ., data = sample_data)
    coef(model)
  },
  R = 1000
)

bootstrap_summary <- boot.ci(bootstrap_results, type = "perc")
bootstrap_summary
```

